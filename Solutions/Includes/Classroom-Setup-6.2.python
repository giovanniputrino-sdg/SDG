{"version":"NotebookV1","origId":779539500130241,"name":"Classroom-Setup-6.2","language":"python","commands":[{"version":"CommandV1","origId":779539500130242,"guid":"0a71cb7c-0ce9-45a8-a697-e7b0b36a37ec","subtype":"command","commandType":"auto","position":2.0,"command":"%run ./_utility-methods $lesson=\"6.2\"","commandVersion":1,"state":"finished","results":{"type":"raw","data":"","arguments":{},"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"febf90d5-c984-43a9-b033-95ae8aef425e"},{"version":"CommandV1","origId":779539500130243,"guid":"6b65bc1c-4695-4d0d-a1eb-4a99a7aa6a65","subtype":"command","commandType":"auto","position":3.0,"command":"%run ./mount-datasets","commandVersion":1,"state":"finished","results":{"type":"raw","data":"","arguments":{},"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"009f912b-ec25-4864-9ce0-0d79eec070ad"},{"version":"CommandV1","origId":779539500130244,"guid":"51379f14-fd0f-4d34-a66c-b39f7e0c0bed","subtype":"command","commandType":"auto","position":4.0,"command":"def autoload_to_table(data_source, source_format, table_name, checkpoint_directory):\n    (spark.readStream\n        .format(\"cloudFiles\")\n        .option(\"cloudFiles.format\", source_format)\n        .option(\"cloudFiles.schemaLocation\", checkpoint_directory)\n        .load(data_source)\n        .writeStream\n        .option(\"checkpointLocation\", checkpoint_directory)\n        .option(\"mergeSchema\", \"true\")\n        .trigger(availableNow=True)\n        .table(table_name)\n        .awaitTermination()\n    )","commandVersion":1,"state":"finished","results":{"type":"raw","data":"","arguments":{},"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"5849b81f-8832-4b70-9c3c-ee58434d0a4a"},{"version":"CommandV1","origId":779539500130245,"guid":"064e992b-50f2-4a32-804b-7db2b28c3c98","subtype":"command","commandType":"auto","position":5.0,"command":"class DataFactory:\n    def __init__(self):\n        self.source = \"/mnt/training/healthcare/tracker/streaming/\"\n        self.userdir = f\"{DA.paths.working_dir}/tracker\"\n        self.curr_mo = 1\n    \n    def load(self, continuous=False):\n        if self.curr_mo > 12:\n            print(\"Data source exhausted\\n\")\n            \n        elif continuous == True:\n            while self.curr_mo <= 12:\n                curr_file = f\"{self.curr_mo:02}.json\"\n                dbutils.fs.cp(f\"{self.source}/{curr_file}\", f\"{self.userdir}/{curr_file}\")\n                self.curr_mo += 1\n                autoload_to_table(self.userdir, \"json\", \"bronze\", f\"{DA.paths.checkpoints}/bronze\")\n        else:\n            curr_file = f\"{str(self.curr_mo).zfill(2)}.json\"\n            target_dir = f\"{self.userdir}/{curr_file}\"\n            print(f\"Loading the file {curr_file} to the {target_dir}\")\n            \n            dbutils.fs.cp(f\"{self.source}/{curr_file}\", f\"{self.userdir}/{curr_file}\")\n            self.curr_mo += 1\n            autoload_to_table(self.userdir, \"json\", \"bronze\", f\"{DA.paths.checkpoints}/bronze\")\n        ","commandVersion":1,"state":"finished","results":{"type":"raw","data":"","arguments":{},"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"9cb6a014-16cf-4476-9115-00f716f585a3"},{"version":"CommandV1","origId":779539500130246,"guid":"6040067c-2e00-4f36-bead-fde699fefbc3","subtype":"command","commandType":"auto","position":6.0,"command":"DA.init()\nDA.paths.checkpoints = f\"{DA.paths.working_dir}/_checkpoints\"    \nDA.data_factory = DataFactory()\n\nprint()\nDA.data_factory.load()\nDA.conclude_setup()\n\nsqlContext.setConf(\"spark.sql.shuffle.partitions\", spark.sparkContext.defaultParallelism)\n","commandVersion":1,"state":"finished","results":{"type":"raw","data":"","arguments":{},"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"6dafec6a-148f-4928-94fd-0e91378c1414"}],"dashboards":[],"guid":"527af664-1c13-430b-89b5-acca7302d805","globalVars":{},"iPythonMetadata":null,"inputWidgets":{},"notebookMetadata":{"pythonIndentUnit":2},"reposExportFormat":"SOURCE"}