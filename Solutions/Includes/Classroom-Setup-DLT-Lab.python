{"version":"NotebookV1","origId":779539500130360,"name":"Classroom-Setup-DLT-Lab","language":"python","commands":[{"version":"CommandV1","origId":779539500130361,"guid":"693c59ad-f3de-4c33-bfbb-9dbd3ea5848d","subtype":"command","commandType":"auto","position":2.0,"command":"%run ./_utility-methods $lesson=\"dlt_lab\"","commandVersion":1,"state":"finished","results":{"type":"raw","data":"","arguments":{},"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"f0f8c0d9-3e5f-4a53-9a68-64358735c106"},{"version":"CommandV1","origId":779539500130362,"guid":"5814a68b-dec7-432c-a4e2-9403dee319cf","subtype":"command","commandType":"auto","position":3.0,"command":"%run ./mount-datasets","commandVersion":1,"state":"finished","results":{"type":"raw","data":"","arguments":{},"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"8bc6ef68-97d9-4053-b95e-819a6d276c03"},{"version":"CommandV1","origId":779539500130363,"guid":"1ba69eae-8893-4bfb-a5bf-52681d8498cd","subtype":"command","commandType":"auto","position":4.0,"command":"def print_sql(rows, sql):\n    displayHTML(f\"\"\"<body><textarea style=\"width:100%\" rows={rows}> \\n{sql.strip()}</textarea></body>\"\"\")\n    ","commandVersion":1,"state":"finished","results":{"type":"raw","data":"","arguments":{},"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"7edfa59b-c7c5-4be6-aeba-15f5205bd596"},{"version":"CommandV1","origId":779539500130364,"guid":"b1a35d25-1e8b-474e-b14e-f9ff981c7912","subtype":"command","commandType":"auto","position":5.0,"command":"generate_register_dlt_event_metrics_sql_string = \"\"\n\ndef _generate_register_dlt_event_metrics_sql():\n    global generate_register_dlt_event_metrics_sql_string\n    \n    generate_register_dlt_event_metrics_sql_string = f\"\"\"\nCREATE TABLE IF NOT EXISTS {DA.db_name}.dlt_events\nLOCATION '{DA.paths.storage_location}/system/events';\n\nCREATE VIEW IF NOT EXISTS {DA.db_name}.dlt_success AS\nSELECT * FROM {DA.db_name}.dlt_events\nWHERE details:flow_progress:metrics IS NOT NULL;\n\nCREATE VIEW IF NOT EXISTS {DA.db_name}.dlt_metrics AS\nSELECT timestamp, origin.flow_name, details \nFROM {DA.db_name}.dlt_success\nORDER BY timestamp DESC;\"\"\".strip()\n    \n    print_sql(13, generate_register_dlt_event_metrics_sql_string)\nDA.generate_register_dlt_event_metrics_sql = _generate_register_dlt_event_metrics_sql","commandVersion":1,"state":"finished","results":{"type":"raw","data":"","arguments":{},"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"88fde279-9abc-4bd1-a29d-13e3c7791030"},{"version":"CommandV1","origId":779539500130365,"guid":"307002c6-52c9-4ecf-9e89-9b070a64bcde","subtype":"command","commandType":"auto","position":6.0,"command":"def _generate_daily_patient_avg():\n    sql = f\"SELECT * FROM {DA.db_name}.daily_patient_avg\"\n    print_sql(3, sql)\n\nDA.generate_daily_patient_avg = _generate_daily_patient_avg","commandVersion":1,"state":"finished","results":{"type":"raw","data":"","arguments":{},"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"cbb121c7-de13-4408-8183-f7f75e968382"},{"version":"CommandV1","origId":779539500130366,"guid":"019266e2-b64b-492c-a902-6bc9b621d26b","subtype":"command","commandType":"auto","position":7.0,"command":"def _generate_visualization_query():\n    sql = f\"\"\"\nSELECT flow_name, timestamp, int(details:flow_progress:metrics:num_output_rows) num_output_rows\nFROM {DA.db_name}.dlt_metrics\nORDER BY timestamp DESC;\"\"\"\n    \n    print_sql(5, sql)\n\nDA.generate_visualization_query = _generate_visualization_query","commandVersion":1,"state":"finished","results":{"type":"raw","data":"","arguments":{},"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"82a227ee-317a-4e78-8b70-4c115de63f4c"},{"version":"CommandV1","origId":779539500130367,"guid":"14f9e0cc-b1ab-4cc1-afa0-9bf0dd630ead","subtype":"command","commandType":"auto","position":8.0,"command":"class DataFactory:\n    def __init__(self):\n        self.source = f\"{DA.paths.data_source}/tracker/streaming/\"\n        self.userdir = DA.paths.data_landing_location\n        try:\n            self.curr_mo = 1 + int(max([x[1].split(\".\")[0] for x in dbutils.fs.ls(self.userdir)]))\n        except:\n            self.curr_mo = 1\n    \n    def load(self, continuous=False):\n        if self.curr_mo > 12:\n            print(\"Data source exhausted\\n\")\n        elif continuous == True:\n            while self.curr_mo <= 12:\n                curr_file = f\"{self.curr_mo:02}.json\"\n                target_dir = f\"{self.userdir}/{curr_file}\"\n                print(f\"Loading the file {curr_file} to the {target_dir}\")\n                dbutils.fs.cp(f\"{self.source}/{curr_file}\", target_dir)\n                self.curr_mo += 1\n        else:\n            curr_file = f\"{str(self.curr_mo).zfill(2)}.json\"\n            target_dir = f\"{self.userdir}/{curr_file}\"\n            print(f\"Loading the file {curr_file} to the {target_dir}\")\n\n            dbutils.fs.cp(f\"{self.source}/{curr_file}\", target_dir)\n            self.curr_mo += 1","commandVersion":1,"state":"finished","results":{"type":"raw","data":"","arguments":{},"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"cae02a28-c383-43e3-ae76-2a3f14ae9ee4"},{"version":"CommandV1","origId":779539500130368,"guid":"e97d55d5-1d35-4f3a-923a-d7f5aeaa4dc4","subtype":"command","commandType":"auto","position":9.0,"command":"DA.init()\n\nDA.paths.data_source = \"/mnt/training/healthcare\"\nDA.paths.storage_location = f\"{DA.paths.working_dir}/storage\"\n\nDA.paths.data_landing_location    = f\"{DA.paths.working_dir}/source/tracker\"\n\n# bronzePath             = f\"{DA.paths.wokring_dir}/bronze\"\n# recordingsParsedPath   = f\"{DA.paths.wokring_dir}/silver/recordings_parsed\"\n# recordingsEnrichedPath = f\"{DA.paths.wokring_dir}/silver/recordings_enriched\"\n# dailyAvgPath           = f\"{DA.paths.wokring_dir}/gold/daily_avg\"\n\n# checkpointPath               = f\"{DA.paths.wokring_dir}/checkpoints\"\n#bronzeCheckpoint             = f\"{DA.paths.checkpoints}/bronze\"\n# recordingsParsedCheckpoint   = f\"{DA.paths.checkpoints}/recordings_parsed\"\n# recordingsEnrichedCheckpoint = f\"{DA.paths.checkpoints}/recordings_enriched\"\n# dailyAvgCheckpoint           = f\"{DA.paths.checkpoints}/dailyAvgPath\"\n\nDA.data_factory = DataFactory()\nDA.conclude_setup()\n\n# sqlContext.setConf(\"spark.sql.shuffle.partitions\", spark.sparkContext.defaultParallelism)\n","commandVersion":1,"state":"finished","results":{"type":"raw","data":"","arguments":{},"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"nuid":"c73c56cf-812e-4f01-a20e-f7021a3c69d7"}],"dashboards":[],"guid":"a130e5bf-79c6-4fb9-a0d9-b5e3ceacbd0e","globalVars":{},"iPythonMetadata":null,"inputWidgets":{},"notebookMetadata":{"pythonIndentUnit":2},"reposExportFormat":"SOURCE"}